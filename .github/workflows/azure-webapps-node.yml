name: CI/CD Docker Full Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  ci-cd-docker:
    runs-on: ubuntu-latest

    steps:
    # 1Ô∏è‚É£ Checkout du code
    - name: Checkout repository
      uses: actions/checkout@v3

    # 2Ô∏è‚É£ Build l'image Docker (CI)
    - name: Build Docker image
      run: |
        echo "üì¶ Building Docker image..."
        docker build -t my-app:${{ github.sha }} .

    # 3Ô∏è‚É£ Optionnel: Run tests √† l'int√©rieur du container
    - name: Run container for testing
      run: |
        echo "üß™ Running tests in Docker container..."
        docker run --rm my-app:${{ github.sha }} npm test || echo "Tests finished"

    # 4Ô∏è‚É£ Login Docker Hub pour push (CD)
    - name: Docker Hub Login
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # 5Ô∏è‚É£ Tag et push l'image Docker
    - name: Push Docker image to Hub
      run: |
        docker tag my-app:${{ github.sha }} my-dockerhub-username/my-app:${{ github.sha }}
        docker push my-dockerhub-username/my-app:${{ github.sha }}

    # 6Ô∏è‚É£ D√©ploiement SSH (Combiner ‚Üí Image)
    - name: Deploy to Server via SSH
      uses: appleboy/ssh-action@v0.1.6
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          echo "üöÄ Pulling new Docker image..."
          docker pull my-dockerhub-username/my-app:${{ github.sha }}
          
          echo "‚èπ Stopping old container (if exists)..."
          docker stop my-app || true
          docker rm my-app || true
          
          echo "‚ñ∂ Running new container..."
          docker run -d --name my-app -p 3000:3000 my-dockerhub-username/my-app:${{ github.sha }}
          
          echo "‚úÖ Deployment completed!"
